{% extends 'admin/base.html' %}

{% block title %}Admin Dashboard - Badminton Tracker{% endblock %}

{% block admin_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
        <a href="{{ url_for('admin.session_new') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-plus mr-2"></i>Th√™m bu·ªïi ch∆°i
        </a>
    </div>

    <!-- Stats All Time: Ch∆∞a thanh to√°n v√† Nh·∫≠n l·∫°i -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- T·ªïng ch∆∞a thanh to√°n -->
        <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-xl shadow p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm">üí∞ T·ªïng ch∆∞a thanh to√°n</p>
                    <p class="text-3xl font-bold mt-1">{{ total_owed_all_time. total_owed | format_currency }}</p>
                    <p class="text-white/80 text-sm mt-2">{{ total_owed_all_time.people_count }} Ng∆∞·ªùi c√≤n ch∆∞a thanh to√°n</p>
                </div>
                <div class="bg-white/20 p-4 rounded-full">
                    <i class="fas fa-hand-holding-usd text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- T·ªïng c·∫ßn tr·∫£ l·∫°i -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl shadow p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm">üí∏ T·ªïng ti·ªÅn c·∫ßn tr·∫£ l·∫°i</p>
                    <p class="text-3xl font-bold mt-1">{{ total_to_receive_all_time.total_to_receive | format_currency }}</p>
                    <p class="text-white/80 text-sm mt-2">{{ total_to_receive_all_time.people_count }} ng∆∞·ªùi ƒë∆∞·ª£c nh·∫≠n</p>
                </div>
                <div class="bg-white/20 p-4 rounded-full">
                    <i class="fas fa-wallet text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats th√°ng n√†y -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Bu·ªïi ch∆°i (T{{ current_month }})</p>
                    <p class="text-2xl font-bold text-gray-800">{{ summary.sessions_count }}</p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fas fa-calendar-check text-green-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Chi ph√≠ (T{{ current_month }})</p>
                    <p class="text-2xl font-bold text-gray-800">{{ summary.total_cost | format_currency }}</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fas fa-money-bill text-blue-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Ch∆∞a thanh to√°n th√°ng n√†y</p>
                    <p class="text-2xl font-bold text-red-600">{{ summary.total_owed | format_currency }}</p>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                    <i class="fas fa-clock text-red-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Ng∆∞·ªùi ch∆°i</p>
                    <p class="text-2xl font-bold text-gray-800">{{ players | length }}</p>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="fas fa-users text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Ng∆∞·ªùi c√≤n ch∆∞a thanh to√°n -->
        <div class="bg-white rounded-xl shadow">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">
                    <i class="fas fa-user-clock mr-2 text-red-500"></i>Ng∆∞·ªùi c√≤n ch∆∞a thanh to√°n
                </h2>
                <a href="{{ url_for('admin.quick_payment') }}" class="text-green-600 text-sm hover:underline">
                    Thanh to√°n nhanh ‚Üí
                </a>
            </div>
            <div class="p-4">
                {% if all_time_debts and all_time_debts | length > 0 %}
                <div class="space-y-2">
                    {% for debt in all_time_debts[:5] %}
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-red-700 font-medium text-sm">{{ debt._id[0] }}</span>
                            </div>
                            <div>
                                <span class="font-medium">{{ debt._id }}</span>
                                <span class="text-gray-500 text-sm ml-2">({{ debt.sessions_count }} bu·ªïi)</span>
                            </div>
                        </div>
                        <span class="text-red-600 font-semibold">{{ debt.total_owed | format_currency }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% if all_time_debts | length > 5 %}
                <p class="text-center text-gray-500 text-sm mt-3">
                    v√† {{ all_time_debts | length - 5 }} ng∆∞·ªùi kh√°c...
                </p>
                {% endif %}
                {% else %}
                <p class="text-center text-gray-500 py-4">
                    <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i><br>
                    Kh√¥ng c√≤n ai ch∆∞a thanh to√°n üéâ
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Ng∆∞·ªùi ƒë∆∞·ª£c nh·∫≠n l·∫°i ti·ªÅn -->
        <div class="bg-white rounded-xl shadow">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">
                    <i class="fas fa-hand-holding-usd mr-2 text-blue-500"></i>Ng∆∞·ªùi ƒë∆∞·ª£c nh·∫≠n l·∫°i
                </h2>
                <a href="{{ url_for('admin.quick_payment') }}? type=receive" class="text-green-600 text-sm hover:underline">
                    Xem t·∫•t c·∫£ ‚Üí
                </a>
            </div>
            <div class="p-4">
                {% if all_time_to_receive and all_time_to_receive | length > 0 %}
                <div class="space-y-2">
                    {% for item in all_time_to_receive[:5] %}
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-blue-700 font-medium text-sm">{{ item._id[0] }}</span>
                            </div>
                            <div>
                                <span class="font-medium">{{ item._id }}</span>
                                <span class="text-gray-500 text-sm ml-2">({{ item.sessions_count }} bu·ªïi)</span>
                            </div>
                        </div>
                        <span class="text-blue-600 font-semibold">+{{ item.total_to_receive | format_currency }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-gray-500 py-4">
                    <i class="fas fa-wallet text-gray-400 text-2xl mb-2"></i><br>
                    Kh√¥ng c√≥ ai c·∫ßn nh·∫≠n l·∫°i ti·ªÅn
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bu·ªïi g·∫ßn ƒë√¢y -->
    <div class="bg-white rounded-xl shadow">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="font-semibold text-gray-800"><i class="fas fa-history mr-2 text-purple-500"></i>Bu·ªïi ch∆°i g·∫ßn ƒë√¢y</h2>
            <a href="{{ url_for('admin.sessions') }}" class="text-green-600 text-sm hover:underline">Xem t·∫•t c·∫£ ‚Üí</a>
        </div>
        <div class="p-4">
            {% if recent_sessions %}
            <div class="space-y-2">
                {% for s in recent_sessions[:5] %}
                <a href="{{ url_for('admin.session_detail', session_id=s._id) }}"
                   class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div>
                        <span class="font-medium">{{ s. date | format_date }}</span>
                        <span class="text-gray-500 text-sm ml-2">({{ s. participants | length }} ng∆∞·ªùi)</span>
                        {% set unpaid = namespace(count=0) %}
                        {% for p in s. participants %}
                            {% if not p.is_paid and (p.amount_to_receive | default(0)) == 0 %}
                                {% set unpaid.count = unpaid.count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {% if unpaid.count > 0 %}
                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">{{ unpaid.count }} ch∆∞a tr·∫£</span>
                        {% endif %}
                        {% set to_receive_count = namespace(count=0) %}
                        {% for p in s.participants %}
                            {% if (p.amount_to_receive | default(0)) > 0 %}
                                {% set to_receive_count.count = to_receive_count.count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {% if to_receive_count.count > 0 %}
                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">{{ to_receive_count.count }} nh·∫≠n l·∫°i</span>
                        {% endif %}
                    </div>
                    <span class="text-green-600 font-semibold">{{ s.total_cost | format_currency }}</span>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-center text-gray-500 py-4">Ch∆∞a c√≥ bu·ªïi ch∆°i n√†o</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}